<ion-content>
  <main>
    <div class="event">
      <div class="event-header">
        <div class="event-header__content height-header" style="background-image: url('{{backgroundImages}}');">
          
          <div class="event-header__background__dark height-header"></div>
          <div class="header-block height-header">
            <div class="header-content__wrapper">
              <div class="event-header__content__top">
                <img (click)="backNavigate()" src="/assets/icons/back-arrow.svg" alt="">
                <span>Подробности гонки</span>
               <img src="/assets/icons/circle_menu.svg" alt="">
              </div>
              <ng-container  *ngIf="event">
                <div class="content">
                  <h2 class="event-name">{{event.name}}</h2>
                  <div *ngIf="event.track" class="event-address">{{event.track.address}}</div>
                </div>
    
              </ng-container>
            </div>
        
            <div *ngIf="currentTab == 'Информация'" class="bottom">
              <ng-container *ngIf="event">
                <div *ngIf="event.date_start" class="event-date">
                  <div class="date-start">
                    <div class="date-name header-bottom__title">
                      Дата
                    </div>
                    <div class="date-content">
                      {{event.date_start | date:'dd MMM YYYY' }}
                    </div>
                  </div>
                  <div class="date-time">
                    <div class="date-name header-bottom__title">
                      Время начала
                    </div>
                    <div class="date-content">
                      {{event.date_start | date:'HH:MM' }}
                    </div>
                  </div>
               </div>
               <div *ngIf="event.track && event.track.name" class="event-track">
                <div class="header-bottom__title">
                  Трасса
                </div>
                <div (click)="redirectInRace()" class="event-track__name">
                  {{event.track.name}}
                  <img src="/assets/icons/arrow-link.svg" alt="Ссылка на трек">
                </div>
               </div>
               <div *ngIf="event.grades && event.grades.length" class="event-grades">
                <div class="header-bottom__title">
                  Классы соревнования
                </div>
                <div class="event-grade" *ngFor="let grade of event.grades">
                  {{grade.name}}
                </div>
               </div>
               <div class="header-buttons__grid">
                  <button (click)="goToPoint()" class="header-button"> 
                    <img src="/assets/icons/map.svg" alt="">Показать на карте
                  </button>
               </div>
  
              </ng-container>
            </div>
          </div>
        </div>
      </div>
      <div class="event-content">
        <div class="event-content__tabs-grid">
          <div *ngFor="let tab of eventTabs" class="tab-container">
            <app-tab-element  (change)="changeTab($event)" [active]="tab.state" [text]="tab.name" ></app-tab-element>
          </div>      
        </div>
        <ng-container *ngIf="event">
          <ng-container *ngIf="currentTab == 'Информация'">
            <div class="event-information">
              <ng-container *ngIf="event.desc && event.desc.length">  
                <div class="event-desc--wrapper">
                  <div class="event-information-title">
                    <img src="/assets/icons/red-finished.svg" alt="">
                    Описание
                  </div>
                  <div *ngIf="event.desc && event.desc.length" [innerHTML]="clearDescription()" class="event-desc"></div>
                </div>
              </ng-container>

              <ng-container *ngIf="event.position_file || event.results_file">  
                <div class="event-desc--wrapper">
                  <div class="event-information-title">
                    <img src="/assets/icons/red-finished.svg" alt="">
                    Документы
                  </div>
                  <div class="event-documents-grid">
                    <div  [routerLink]="['/view-document', event.results_file | checkImgUrl]" *ngIf="event.results_file" class="event-documents-grid__item">
                      <div class="document-preview">
                        <img src="/assets/icons/documents.svg" alt="">
                      </div>
                      Регламент
                    </div>
                    <div [routerLink]="['/view-document', event.position_file | checkImgUrl]" *ngIf="event.position_file" class="event-documents-grid__item">
                      <div class="document-preview">
                        <img src="/assets/icons/documents.svg" alt="">
                      </div>
                      Расписание
                    </div>
                  </div>
                </div>
              </ng-container>

              <ng-container *ngIf="event.images && event.images.length">  
   
                <div class="event-desc--wrapper">
                  <div class="event-information-title">
                    <img src="/assets/icons/red-finished.svg" alt="">
                    Галерея
                  </div>
                  <div class="event-images-grid">
                    <ng-container *ngFor="let image of event.images">
                      <img (click)="openImagesModalFunction()" class="event-images-grid__item"  [src]="image| checkImgUrl" alt="">
                    </ng-container>
                  </div>
                </div>
              </ng-container>
            </div>
          </ng-container>



          <ng-container *ngIf="currentTab == 'Участники'">
            <ng-container *ngIf="usersInRace && usersInRace.length ">
              <div class="event-information-title users-title">
                <img src="/assets/icons/red-finished.svg" alt="">
                Гонщики
                <app-icon-button *ngIf="allUsers.length" font="font-bold" widht="w20" theme="red" clippy="clippy-right" height="auto-height" [buttonText]="allUsers.length"></app-icon-button>
              </div>
              <div class="grades-filter-grid">
                <app-icon-button (click)="selectGradeFilter('')" [theme]=" currentGradeName == '' ? 'red' : 'dark-gray' " *ngIf="allUsers.length" widht="w20" clippy="clippy-right" height="little-height" buttonText="Все"></app-icon-button>
                <ng-container *ngFor=" let group of usersInRace">
                  <app-icon-button (click)="selectGradeFilter(group.group)" [theme]=" currentGradeName == group.group ? 'red' : 'dark-gray' "  *ngIf="allUsers.length" widht="w20" clippy="clippy-right" height="little-height" [buttonText]="group.group"></app-icon-button>
                </ng-container>
              </div>
              <div class="group-grid">
                <ng-container  *ngFor="let group of usersInRace">
                  <ng-container *ngIf="currentGradeName == '' || currentGradeName == group.group ">
                    <div *ngIf="group.users.length" class="group-grid__item">
                      <div class="event-information-title">
                        <img src="/assets/icons/red-finished.svg" alt="">
                        {{group.group}}
                        <app-icon-button font="font-bold" widht="w20" theme="red" clippy="clippy-right" height="auto-height" [buttonText]="group.users.length"></app-icon-button>
                      </div> 
                      <div class="users-grid">
                        <ng-container *ngFor="let user of group.users">
                          <app-user-section [startNumber]="true" [showAddress]="true" [name]="true" [surname]="true" [showRank]="true" [user]="user"></app-user-section>
                        </ng-container>
                      </div>
                  
        
                    </div>
                  </ng-container>
                
                </ng-container>
                
              </div>
            </ng-container>

            <ng-container *ngIf="!usersInRace || usersInRace.length == 0 ">
              <div class="not-found-users">Гонщиков пока что нет...</div>
            </ng-container>
            
          
          </ng-container>
          <ng-container *ngIf="currentTab == 'Результаты'">
            <p>Результаты</p>
          </ng-container>
        </ng-container>
        
        
        
      </div>
  
    </div>
  

  @if (this.event) {
   
    
      <!-- <div class="slider-container">
        <app-show-slider standartImagesPath='assets/images/moto-background.png' [files]="event.images" (click)="openImagesModalFunction()"></app-show-slider>
        <div class="slider-container__header">
        </div> 
      </div> -->

      
    <!-- <div class="main-container-parent">

      <app-images-modal  *ngIf="event.images && event.images.length " [openModal]="statusImagesModal" (closeModalEmit)="closeImagesModal()" [imagesPathArray]="event.images"></app-images-modal>
      <div class="event-id">EID:{{event.id}}</div>
      <div class="">
        <div class="event-name">{{event.name}}</div>
        <div class="event-location-name">
          <div class="event-location-name__text">{{event.location?.name}} {{event.location?.type}}</div>
        </div>
        <div [innerHTML]="clearDescription()" *ngIf="event.desc" class="event-description">{{event.desc}}</div>

        <div *ngIf="event.grades && event.grades.length" class="groups">
          <span class="groups-header">Классы соревнования:</span>
          <div class="group-item" *ngFor="let group of event.grades">
            <div class="group-item__name">{{group.name}}</div>
          </div>
        </div>
        
        <div *ngIf="event.position_file || event.results_file" class="event-documents">
           <span *ngIf="event.results_file" [routerLink]="['/view-document', event.results_file | checkImgUrl]" class="event-documents__text"> <img class="event-documents__icon" src="/assets/icons/documents.svg"> Регламент</span>
           <span *ngIf="event.position_file" [routerLink]="['/view-document', event.position_file | checkImgUrl]" class="event-documents__text"> <img class="event-documents__icon" src="/assets/icons/documents.svg"alt=""> Положение</span>
           
           <ng-container *ngFor="let document of formattedResultsDocument">
            <span (click)="openUploadResultModalState(document)" *ngIf="document" class="event-documents__text"><img class="event-documents__icon" src="/assets/icons/documents.svg" alt=""> {{document.path| checkResultsPath}} </span>
           </ng-container>
        </div>
        <ng-container *ngIf="event.pdf_files && event.pdf_files.length ">
          <ion-modal [isOpen]="resultModalState" class="upload-result-modal">
            <ng-template>
              <ion-content>
                <app-header headerTitle="Результаты гонки" [customBack]="true" (customBackClick)="closeUploadResultModalState()"></app-header>
                <ng-container *ngIf="currentResultFile">
                  <div class="documents-grid">

                      <div class="documents-grid__item">
                        <pdf-viewer 
                        [src]="currentResultFile.path | checkImgUrl"
                        [render-text]="true"
                        [zoom]="currentResultFile.zoomLevel"
                        [original-size]="false"
                        class="file__img"
                        ></pdf-viewer>
                        <div class="button-container--pdf">
                          <app-circle-button class="circle-button" [icon]="'assets/icons/plus.svg'" (click)="zoomIn(currentResultFile)"></app-circle-button>
                          <app-circle-button class="circle-button" [icon]="'assets/icons/minus.svg'" (click)="zoomOut(currentResultFile)"></app-circle-button>
                          <app-circle-button class="circle-button" [icon]="'assets/icons/close.svg'" (click)="resetZoom(currentResultFile)"></app-circle-button>
                        </div>
                      </div>
                  </div>
                </ng-container>
              </ion-content>
            </ng-template>
          </ion-modal>
        </ng-container>

        <div class="event-track">
    
          <app-track-section [hidhtStatus]="true" (click)="redirectInRace()" [track]="event.track"></app-track-section>
        </div>
        

        <div class="list-users-container">
          @if (usersPreviewConfig.usersCount) {
            <div class="user-modal-header">
              Участники гонки
              {{usersPreviewConfig.usersCount}}
            </div>
          <app-users-preview 
          [groups]="event.grades"  
          [fullValueUsers]="usersPreviewConfig.usersCount" 
          [users]="usersInRace" [moreCount]="usersPreviewConfig.usersCount" 
          [openUsersModal]="openUserModalValue" 
          (closeModalEmit)="closeStateUsersModal()" 
          (openModalEmit)="openStateUsersModal()"></app-users-preview>
        }
        </div>

      </div>
      
   
    </div> -->
    <!-- <div class="button-commission">
      <app-standart-button buttonText="Просмотр заявок" (click)="redirectApplicationForRace()"></app-standart-button>
    </div> -->
    <div class="footer-page">
      <div *ngIf="event.status?.name !== 'Планируемая' && !checkDateStartInRace()"  class="footer">

        

        @if (!this.event.appointments_exists && !checkRecordStart() && !checkRecordEnd()) {
          <div class="red-button">
            <app-icon-button (click)="openApplicationForm()" [widht]="'full'" [clippy]="'clippy-right'" [shapeColumn]="true"  buttonText="Заявиться" [theme]="'red'"></app-icon-button>
          </div>
        }
        @else if(checkRecordStart()){
          <div class="dark-gray-button">
            <app-icon-button  theme="dark-gray" [widht]="'full'"  buttonText="Дата начала регистрации: {{event.record_start}}"></app-icon-button>
          </div>
        }
        @else {
          <div class="dark-gray-button">
            <app-icon-button  theme="dark-gray" [clippy]="'clippy-right'" [shapeColumn]="true" [widht]="'full'" buttonText="Заявка отправлена"></app-icon-button>
          </div>
        }

        <div class="group-button" *ngIf="!checkRecordStart()">
          @if(checkUserRoleService.userHaveRole(confirmUsersRolesInGroupAplication) && !checkRecordStart()){
        
          <div class="red-button">
            <app-icon-button (click)="redirectTrenerInEditAplication()" [widht]="'full'" buttonText="Заявиться командой" [clippy]="'clippy-right'" [shapeColumn]="true" [theme]="'red'"></app-icon-button>
          </div>
          
        }
          @else if(checkRecordStart() && checkRecordEnd()){
          
            <div class="red-button">
              <app-icon-button [disabled]="true" [clippy]="'clippy-right'" [widht]="'full'" [shapeColumn]="true" [theme]="'red'" buttonText="Дата начала регистрации: {{event.record_start}}"></app-icon-button>
            </div>
          
          }
          @else {
            
          }
        </div>
        
       
      </div>
    </div>
     

    }
  </main>

</ion-content>

@if (this.event) {
<ion-modal [isOpen]="true" (didDismiss)="closeApplicationForm()">
  <!-- applicationFormValueState -->
  <ng-template>
    <ion-content >
      <app-header (customBackClick)="closeApplicationForm()" [customBack]="true" headerTitle="Отправить заявку"></app-header>
      <div class="main-container application-main">
        <div class="race-name">{{event.name}}</div>
        <div class="race-date-start">{{event.date_start |date}}</div>
        

        <form class="personal-form">
          <app-standart-input [control]="personalUserForm.get('surname')" placeholder="Введите фамилию" [errorMessage]="formErrors.surname.errorMessage" [invalid]="formErrors.surname.errorMessage.length !== 0" label="Фамилия*"></app-standart-input>
          <app-standart-input [control]="personalUserForm.get('name')" [errorMessage]="formErrors.name.errorMessage" [invalid]="formErrors.name.errorMessage.length !== 0" placeholder="Введите имя" label="Имя*"></app-standart-input>
          <app-standart-input [errorMessage]="formErrors.patronymic.errorMessage" [invalid]="formErrors.patronymic.errorMessage.length !== 0" [control]="personalUserForm.get('patronymic')" placeholder="Введите отчество" label="Отчество*"></app-standart-input>
          <app-standart-input [errorMessage]="formErrors.dateOfBirth.errorMessage" [invalid]="formErrors.dateOfBirth.errorMessage.length !== 0" [control]="personalUserForm.get('dateOfBirth')" placeholder="Выберите дату" label="Дата рождения*" type="date"></app-standart-input>
          <app-standart-input [errorMessage]="formErrors.region.errorMessage" [invalid]="formErrors.region.errorMessage.length !== 0" (click)="openRegionModal()" [readonly]="true" label="Область/край*" [control]="personalUserForm.get('region')" placeholder="Выберите область вашу область"></app-standart-input>     
          <app-standart-input [errorMessage]="formErrors.city.errorMessage" [invalid]="formErrors.city.errorMessage.length !== 0" [control]="personalUserForm.get('city')" [errorMessage]="formErrors.city.errorMessage" [invalid]="formErrors.city.errorMessage.length !== 0" placeholder="Введите город" label="Город*"></app-standart-input>     
          <ion-modal class="region-modal" (didDismiss)="closeRegionModal()"  [isOpen]="regionModalState">
            <ng-template>
              <ion-content>
                <div class="region-modal-container">
                  <app-standart-input-search label="Область/край*" [searchCurrentItems]="searchRegionItems" [searchItems]="searchRegionItems" (changeSearchValue)="setRegion($event)"></app-standart-input-search>
                </div>
              </ion-content>
            </ng-template>  
          </ion-modal>        
          
          <app-standart-input [errorMessage]="formErrors.numberAndSeria.errorMessage" [invalid]="formErrors.numberAndSeria.errorMessage.length !== 0" [control]="personalUserForm.get('numberAndSeria')" placeholder="Серия, номер" label="Паспорт/Свидетельство о рождении*"></app-standart-input>

          <div class="start-number-container">
            <app-standart-input [errorMessage]="formErrors.inn.errorMessage" [invalid]="formErrors.inn.errorMessage.length !== 0" [control]="personalUserForm.get('inn')" placeholder="ИНН" label="ИНН*"></app-standart-input>
            <app-standart-input [errorMessage]="formErrors.snils.errorMessage" [invalid]="formErrors.snils.errorMessage.length !== 0" [control]="personalUserForm.get('snils')" placeholder="СНИЛС" label="СНИЛС*"></app-standart-input>
          </div>
          
          
          
          <app-standart-input [control]="personalUserForm.get('phoneNumber')" [errorMessage]="formErrors.phoneNumber.errorMessage" [invalid]="formErrors.phoneNumber.errorMessage.length !== 0" placeholder="Номер телефона" label="Телефон*"></app-standart-input>
          
          
          
          <div class="start-number-container">

            <app-standart-input 
              [errorMessage]="formErrors.startNumber.errorMessage" 
              [invalid]="formErrors.startNumber.errorMessage.length !== 0" 
              [control]="personalUserForm.get('startNumber')" 
              [maxLength]="3" type="number" 
              [invalid]="formErrors.startNumber.errorMessage.length !== 0" 
              [errorMessage]="formErrors.startNumber.errorMessage" 
              placeholder="Стартовый номер" 
              label="Стартовый номер*">
            </app-standart-input>

          </div>
          
          <app-standart-input-select  
            [errorMessage]="formErrors.group.errorMessage" 
            [invalid]="formErrors.group.errorMessage.length !== 0"  
            selectedName="groupSelect" 
            [items]="groupItems" 
            (onChange)="setGroup($event)" 
            [selectedItem]="{name:personalUserForm.value.group, value:personalUserForm.value.group}" 
            label="Класс, группа*">
          </app-standart-input-select>

          <app-standart-input-select  
            [errorMessage]="formErrors.rank.errorMessage" 
            [invalid]="formErrors.rank.errorMessage.length !== 0" 
            selectedName="rankSelect" [items]="sportRankItems" 
            (onChange)="setRank($event)" 
            [selectedItem]="{name:personalUserForm.value.rank, value:personalUserForm.value.rank}" 
            label="Спортивное звание, разряд*">
          </app-standart-input-select>
          
          
          
          <app-standart-input [control]="personalUserForm.get('rankNumber')" placeholder="№ удостоверения (МСМК, МС, КМС)" label="№ удостоверения"></app-standart-input>
          
          
          
          <app-standart-input [errorMessage]="formErrors.community.errorMessage" [invalid]="formErrors.community.errorMessage.length !== 0" (click)="openComandSelectModalStateValue()" [readonly]="true" [control]="personalUserForm.get('community')" placeholder="Команда" label="Название команды*"></app-standart-input>
          <app-standart-input [control]="personalUserForm.get('coach')" placeholder="Тренер" label="ФИО тренера"></app-standart-input>
          <app-standart-input-select [errorMessage]="formErrors.motoStamp.errorMessage" [invalid]="formErrors.motoStamp.errorMessage.length !== 0" selectedName="motoStampSelect" [items]="motoStampItems" (onChange)="setMotoStamp($event)" [selectedItem]="{name:personalUserForm.value.motoStamp, value:personalUserForm.value.motoStamp}" label="Марка мотоцикла*"></app-standart-input-select>
          <app-standart-input-select [errorMessage]="formErrors.engine.errorMessage" [invalid]="formErrors.engine.errorMessage.length !== 0" selectedName="engineSelect" [items]="engineItems" (onChange)="setEngine($event)" [selectedItem]="{name:personalUserForm.value.engine, value:personalUserForm.value.engine}" label="Тип двигателя*"></app-standart-input-select>
          <app-standart-input [] [control]="personalUserForm.get('comment')" label="Комментарий" placeholder="Оставьте комментарий"></app-standart-input>
        </form>
        
          <div class="documents">
            <div class="document-header">Лицензия</div>
            <div class="licenses document-container">
              <app-standart-input [control]="licensesForm.get('number')" placeholder="Лицензия МФР" label="Лицензия МФР (тип, №)*"></app-standart-input>
              <span class="scan-header">Скан или фотография Лицензии</span>
              <app-file-input (click)="!licensesFile ? licensesFileInput.click(): showToastInfoFileUpload()" [fileName]="licensesFile.name"></app-file-input>
              <input (change)="setLicensesFile($event)" #licensesFileInput style="display: none;"  type="file">
            </div>

            <div class="document-header">Страховой полис</div>
            <div class="polis document-container">
              <app-standart-input [errorMessage]="documentsError.polisNumber.errorMessage" [invalid]="documentsError.polisNumber.errorMessage.length !== 0"  [control]="polisForm.get('number')" placeholder="Серия, номер" label="Серия и номер*"></app-standart-input>
              <app-standart-input [errorMessage]="documentsError.issuedWhom.errorMessage" [invalid]="documentsError.issuedWhom.errorMessage.length !== 0" [control]="polisForm.get('issuedWhom')" placeholder="Кем выдан" label="Кем выдан*"></app-standart-input>
              <app-standart-input [errorMessage]="documentsError.itWorksDate.errorMessage" [invalid]="documentsError.itWorksDate.errorMessage.length !== 0" [control]="polisForm.get('itWorksDate')" placeholder="Срок действия" type="date" label="Срок действия*"></app-standart-input>
              <span class="scan-header">Скан или фотография Полиса</span>
              <app-file-input [fileName]="polisFile.name" (click)="!polisFile ? polisFileInput.click(): showToastInfoFileUpload()"></app-file-input>
              <input (change)="setPolisFile($event)" #polisFileInput style="display: none;"  type="file">
            </div>

            <div class="document-header">Нотариальное согласие родителей</div>
            <div class="polis document-container">
              <span class="scan-header">Скан или фотография Нотариального согласия</span>
              <app-file-input [fileName]="notariusFile.name" (click)="!notariusFile ? notariusFileInput.click(): showToastInfoFileUpload()"></app-file-input>
              <input (change)="setNotariusFile($event)" #notariusFileInput style="display: none;"  type="file">
            </div>
        </div>
      </div>
      
      <div class="footer">
        <app-standart-button theme="big" (click)="toggleAplicationInRace()" buttonText="Заявиться"></app-standart-button>
      </div>
    </ion-content>
  </ng-template>
  </ion-modal>

<app-confirm-modal text="Ваши данные были изменены, сохранить их?" [openModal]="changePersonalDateModalValue" (confirm)="saveNewPersonal()" (cancel)="closePersonalNewModal()" ></app-confirm-modal>
<!-- <app-select-comands (openComandSelectModal)="openComandSelectModalStateValue()" (closeComandSelectModal)="closeComandSelectModalStateValue()" [comandSelectModalStateValue]="comandSelectModalStateValue" (selectComand)="setComand($event)"  [commands]="allComands"></app-select-comands> -->

<app-select-comands 
(createNewComand)="createNewComand($event)" 
(openComandSelectModal)="openComandSelectModalStateValue()" 
(closeComandSelectModal)="closeComandSelectModalStateValue()" 
[comandSelectModalStateValue]="comandSelectModalStateValue" 
(selectComand)="setComand($event)"  
[selectedRegion]="selectRegionInCommandModal"
(setSelectedRegion)="selectRegionInCommandModalFunction($event)"
[commands]="allComands"
[regions]="searchRegionItems"
[createRegions]="createRegionItems"
(clearFilterRegion)="clearRegionInComandFilter()"
></app-select-comands>}

<ng-container *ngIf="event">
  <app-images-modal  *ngIf="event.images && event.images.length " [openModal]="statusImagesModal" (closeModalEmit)="closeImagesModal()" [imagesPathArray]="event.images"></app-images-modal>
</ng-container>

